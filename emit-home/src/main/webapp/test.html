<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>EMIT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<link href="css/sb-admin-2.css" rel="stylesheet">
<link href="css/rzslider.css" rel="stylesheet">
</head>
<script type="text/javascript" src="DJS/Chart.min.js"></script>
<script type="text/javascript"
	src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script type="text/javascript"
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript"
	src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.2/angular.min.js"></script>
<script type="text/javascript" src="DJS/angular-chart.min.js"></script>
<script type="text/javascript" src="DJS/rzslider.js"></script>
<script type="text/javascript" src="DJS/sb-admin-2.js"></script>
<script type="text/javascript" src="DJS/bootstrap-treeview.js"></script>
<script type="text/javascript" src="DJS/bootstrap-checkbox.min.js" defer></script>

<script type="text/javascript">
	var retrieved_json = [];

	var ANALYSE = {
		general : false,
		analyse : 'Pheasant',
		total_conso : 54,
		time : '15s',
		sloc : 15,
		std_dev : 1.10
	};
	
	function f_numerical_int(dx, y_array) {
	    var maxy = Math.max.apply(null, y_array);
	    var dy_array = y_array.map(function(num) {
	        return Math.abs(maxy - num);
	    });
	    var profile_integral = 0;
	    var n = dy_array.length;
	    for (i = 1; i < n; i++) {
	        var dy_init = dy_array[i - 1];
	        var dy_end = dy_array[i];
	        var darea = dx * (dy_init + dy_end) / 2.;
	        profile_integral = profile_integral + darea;
	    }
	    return profile_integral;
	}
	
	function f_standardDeviation(values){
		  var avg = f_average(values);
		  
		  var squareDiffs = values.map(function(value){
		    var diff = value - avg;
		    var sqrDiff = diff * diff;
		    return sqrDiff;
		  });
		  
		  var avgSquareDiff = f_average(squareDiffs);

		  var stdDev = Math.sqrt(avgSquareDiff);
		  return stdDev;
		};

	function f_average(values) {
		var sum = 0;
		for (var i = 0; i < values.length; i++) {
			sum += values[i];
		}
		var avg = sum / values.length;
		return avg;
	};
	
	var app = angular.module('app', [ 'chart.js', 'rzModule' ]);

	app.filter('ceil', function() {
		return function(input) {
			return Math.ceil(input);
		};
	});

	app
			.controller(
					'controller',
					function($scope, $http, $q) {
						$scope.an_general = ANALYSE.general;
						$scope.an_analyse = ANALYSE.analyse;
						$scope.an_total_conso = ANALYSE.total_conso;
						$scope.an_time = ANALYSE.time;
						$scope.an_sloc = ANALYSE.sloc;
						$scope.an_std_dev = ANALYSE.std_dev;
						$scope.retrieve_json = function() {
							$http
									.get(
											"http://172.21.50.3:8080/emit/test/test?file_name=emit-1464192786377.json")
									.then(
											function(response) {
												var all_abscissa = [];
												var all_ordinate = [];

												$scope.loaded_file = "Loaded file : emit-1464192786377.json";
												$scope.series = [ 'Data',
														'Minimum', 'Maximum',
														'Average' ];

												retrieved_json = response.data;

												for (var i = 0; i < retrieved_json.length; i++) {
													all_abscissa[i] = retrieved_json[i].x / 1000;
													all_ordinate[i] = retrieved_json[i].y;
												}

												$scope.startedtime = Math.min
														.apply(
																Math,
																all_abscissa
																		.map(function(
																				o) {
																			return o;
																		}));
												$scope.stoppedtime = Math.max
														.apply(
																Math,
																all_abscissa
																		.map(function(
																				o) {
																			return o;
																		}));

												$scope.MAJ_slider();
												$scope.refresh_chart();
											});
						};
						$scope.refresh_chart = function() {
							var abscissa = [];
							var ordinate = [];
							var minimum = [];
							var maximum = [];
							var average = [];
							var points = [];
							var serie = [];
							var cpt = 0;

							//Restriction de l'interval de visualisation
							for (var i = 0; i < retrieved_json.length; i++) {
								if ($scope.slider.minValue <= (retrieved_json[i].x / 1000)
										&& (retrieved_json[i].x / 1000) <= $scope.slider.maxValue) {
									abscissa[cpt] = retrieved_json[i].x / 1000;
									ordinate[cpt] = retrieved_json[i].y;
									points[cpt] = retrieved_json[i];
									cpt++;
								}
							}
							
							//Récupération des données remarquables de la courbe (min,max,moy,écart type, aire sous la courbe)
							$scope.minimum = Math.min.apply(Math, ordinate
									.map(function(min) {
										return min;
									}));
							$scope.maximum = Math.max.apply(Math, ordinate
									.map(function(max) {
										return max;
									}));
							$scope.average = Math.round(100 * f_average(ordinate)) / 100;
							$scope.std_dev = Math.round(100 * f_standardDeviation(ordinate)) / 100;
							console.log(abscissa[1] - abscissa[0]);
							$scope.AUC = Math.round(100 * f_numerical_int((abscissa[1] - abscissa[0]), ordinate)) / 100;
							
							//définition des courbes							
							for (var i = 0; i < ordinate.length; i++) {
								minimum[i] = $scope.minimum;
								maximum[i] = $scope.maximum;
								average[i] = $scope.average;
							}
							serie = [ ordinate, minimum, maximum, average ];
							$scope.labels = abscissa
							$scope.data = serie;
							$scope.datasetOverride = [ {
								pointRadius : 3,
							}, {
								pointRadius : 0,
								fill : false,
							}, {
								pointRadius : 0,
								fill : false,
							}, {
								pointRadius : 0,
								fill : false,
							} ];

						};

						//Slider
						$scope.MAJ_slider = function() {
							$scope.slider = {
								minValue : $scope.startedtime,
								maxValue : $scope.stoppedtime,

								options : {
									floor : $scope.startedtime,
									ceil : $scope.stoppedtime,
									step : 0.1,
									precision : 1,
									onEnd : function() {
										$scope.refresh_chart();
									}
								}
							};
						};
						
						//Checkbox stylisées YES/NO
						$(':checkbox').checkboxpicker();
						$('#cb1').prop('checked', $scope.an_general);
						$('#cb1').on('change', function() {
							$('#cb1').prop('checked', $scope.an_general);
						});
						
						$scope.retrieve_json();
					});
</script>
<body ng-app="app" ng-controller="controller">
	<header>
		<div class="navbar navbar-default navbar-custom navbar-static-top"
			id="navigation_barre">
			<div class="container">
				<button type="button" class="navbar-toggle" data-toggle="collapse"
					data-target=".navbar-collapse">
					<span class="sr-only">Toggle navigation</span> <span
						class="icon-bar"></span> <span class="icon-bar"></span> <span
						class="icon-bar"></span>
				</button>
				<a href="./index.html" class="navbar-brand" id="titre_appli">EMIT</a>
				<ul id="menu">
					<li class="active primaire"><a href="./index.html"
						class="primaire"><span class="glyphicon glyphicon-home">&ensp;</span>
							Home</a></li>

					<li class="dropdown primaire"><a href="#"
						class="dropdown-toggle primaire" data-toggle="dropdown"
						role="button" aria-expanded="false"><span
							class="glyphicon glyphicon-pushpin">&ensp;</span> Elements<span
							class="caret"></span></a>
						<ul class="dropdown-menu">
							<li><a href="./Instrument.html">Instruments</a></li>
							<li><a href="./Environment.html">Environments</a></li>
							<li><a href="./Measurand.html">Measurands</a></li>
						</ul></li>
					<li class="active primaire"><a href="./CreateExperiment.html"
						class="primaire"><span class="glyphicon glyphicon-plus">&ensp;</span>Add
							experiment</a></li>
					<li class="active primaire"><a href="./index.html"
						class="primaire"><span class="glyphicon glyphicon-home">&ensp;</span>
							Home</a></li>
				</ul>


			</div>
		</div>
	</header>
	<div id="page-wrapper">
		<div col-md-10>
			<legend ng-model="loaded_file"> {{ loaded_file }} </legend>
			<canvas id="line" class="chart chart-line" chart-data="data"
				chart-labels="labels" chart-series="series" chart-options="options"
				chart-dataset-override="datasetOverride" chart-click="onClick">
			</canvas>
			<rzslider rz-slider-model="slider.minValue"
				rz-slider-high="slider.maxValue" rz-slider-options="slider.options"></rzslider>
			<br> <br>
			<li class="list-group-item">
				<h4 class="list-group-item-heading">Minimum</h4> <input
				class="form-control" type="text" value="{{ minimum }}" readonly>
			</li>
			<li class="list-group-item">
				<h4 class="list-group-item-heading">Maximum</h4> <input
				class="form-control" type="text" value="{{ maximum }}" readonly>
			</li>
			<li class="list-group-item">
				<h4 class="list-group-item-heading">Average</h4> <input
				class="form-control" type="text" value="{{ average }}" readonly>
			</li>
			<li class="list-group-item">
				<h4 class="list-group-item-heading">Standard deviation</h4> <input
				class="form-control" type="text" value="{{ std_dev }}" readonly>
			</li>
			<li class="list-group-item">
				<h4 class="list-group-item-heading">Area under the curve</h4> <input
				class="form-control" type="text" value="{{ AUC }}" readonly>
			</li> <br> <br>
			<legend>Results of the analysis</legend>
			<li class="list-group-item">
				<h4 class="list-group-item-heading">General result</h4> <input
				class="form-control" id="cb1" type="checkbox">
			</li>
			<li class="list-group-item">
				<h4 class="list-group-item-heading">Analyse</h4> <input
				class="form-control" type="text" value="{{ an_analyse }}" readonly>
			</li>
			<li class="list-group-item">
				<h4 class="list-group-item-heading">Total consumption</h4> <input
				class="form-control" type="text" value="{{ an_total_conso }}"
				readonly>
			</li>
			<li class="list-group-item">
				<h4 class="list-group-item-heading">SLOC</h4> <input
				class="form-control" type="text" value="{{ an_sloc }}" readonly>
			</li>
			<li class="list-group-item">
				<h4 class="list-group-item-heading">Time</h4> <input
				class="form-control" type="text" value="{{ an_time }}" readonly>
			</li>
			<li class="list-group-item">
				<h4 class="list-group-item-heading">Standard deviation</h4> <input
				class="form-control" type="text" value="{{ an_std_dev }}" readonly>
			</li>
		</div>
	</div>
</body>
</html>