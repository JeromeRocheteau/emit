<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>EMIT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<link rel="stylesheet" href="./css/font-awesome.min.css">
<link href="css/sb-admin-2.css" rel="stylesheet">
</head>
<script type="text/javascript"
	src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script type="text/javascript"
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript"
	src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.2/angular.min.js"></script>
<script type="text/javascript">
	var app = angular.module('app', []);
	var old_uri;
	var old_name;

	app.filter('ceil', function() {
		return function(input) {
			return Math.ceil(input);
		};
	});

	app
			.controller(
					'controller',
					function($scope, $http, $q) {

						$http
								.get(
										"http://172.21.50.3:8080/emit/measurementSet/list")
								.then(function(response) {
									$scope.measurementsetlist = response.data;
								});

						$http.get("http://172.21.50.3:8080/emit/measure/list")
								.then(function(response) {
									$scope.measures = response.data;
								});

						var empty = {};

						$scope.selected = false;
						$scope.creating = false;
						$scope.updating = false;

						$scope.alert = {};
						$scope.instrument = {};
						$scope.instruments = [];
						$scope.size = 0;
						$scope.offset = 0;
						$scope.length = 5;

						$scope.measure_selection = [];
						$scope.selected_measure = [];
						$scope.features = [];
						$scope.feature = {};

						var init = function() {
							$scope.selected = false;
							$scope.creating = false;
							$scope.updating = false;
							$scope.instrument = angular.copy(empty);
							$scope.measure_selection = [];
							$scope.selected_measure = [];
							$scope.features = [];
							$scope.feature.factor = 0;
							$scope.feature.name = "";
							$scope.feature.no_order = 0;
						}
						$scope.clean = function() {
							init();
						}
						$scope.select = function(instrument) {
							if (instrument) {
								$scope.creating = false;
								$scope.updating = true;
								$scope.instrument = instrument;
								old_uri = instrument.uri;
								old_name = instrument.name;
								$scope.old_name = old_name;

								$http
										.get(
												"http://172.21.50.3:8080/emit/feature/list-one-instrument",
												{
													"params" : {
														"instrument" : instrument.uri
													}
												})
										.then(
												function(success) {
													$scope.features = success.data
												},
												function(error) {
													console
															.log("pas de features définies")
												});

							} else {
								$scope.creating = true;
								$scope.updating = false;
							}
							$scope.selected = true;
						}

						$scope.create = function() {
							//console.log($scope.features);
							var error_flag = false;
							//console.log($scope.features);
							var indata = {
								uri : $scope.instrument.uri,
								name : $scope.instrument.name
							};
							var instru = $scope.instrument.uri;
							var feature_crea = [];
							var instrument_crea = $http
									.post(
											"http://172.21.50.3:8080/emit/instrument/create",
											indata)
									.then(
											function(success) {
												angular
														.forEach(
																$scope.features,
																function(value,
																		key) {
																	var feature_crea = [];
																	var feature_data = {
																		name : value.name,
																		measure : value.measure,
																		factor : value.factor,
																		instrument : instru,
																		no_order : value.no_order
																	};
																	//console.log(feature_data);
																	feature_crea
																			.push($http
																					.post(
																							"http://172.21.50.3:8080/emit/feature/create",
																							feature_data)
																					.then(
																							function(
																									success) {
																								//console.log(' feature  --> ' + value.name);
																							},
																							function(
																									error) {
																								//console.log('feature failed !! ' + value.name);
																								error_flag = true;
																							}));
																});
												//console.log("instrument created");
											}, function(error) {
												//console.log("instrument failed !!");
												error_flag = true;
											});
							if (error_flag == true) {
								alert("An error occured during creation of the instrument.");
							} else {
								$q.all([ instrument_crea, feature_crea ]).then(
										function(values) {
											alert("Instrument created");
											$scope.size = 0;
											$scope.offset = 0;
											size();
											page();
											init();

										});
							}
						}
						$scope.update = function() {
							var feature_crea = [];
							var indata = [ {
								uri : old_uri,
								name : old_name
							}, {
								uri : $scope.instrument.uri,
								name : $scope.instrument.name
							} ];
							var data_feature = {
									instrument : old_uri
								};
							var instru = $scope.instrument.uri; 
							var list_features = $scope.features; 
							var feature_delete = $http
									.post(
											"http://172.21.50.3:8080/emit/feature/delete-one-instrument",
											data_feature).then(
											function(success) {
												console.log('delete feature OK');
											}, function(error) {
												console.log('delete feature PAS OK !');
											});
							$q
									.all([ feature_delete ])
									.then(
											function(values) {
												var intrument_update = $http
												.post(
														"http://172.21.50.3:8080/emit/instrument/update",
														indata)
												.then(
														function(
																success) {
															console.log('update instru OK');
														},
														function(error) {
															console.log('update instru PAS OK !');
															/* alert("An error occured during updating of the instrument."); */
														});
												$q
														.all(
																[ intrument_update ])
														.then(
																function(values) {
																	angular
																	.forEach(
																			list_features,
																			function(
																					value,
																					key) {
																				var feature_crea = [];
																				var feature_data = {
																					name : value.name,
																					measure : value.measure,
																					factor : value.factor,
																					instrument : instru,
																					no_order : value.no_order
																				};
																				feature_crea
																						.push($http
																								.post(
																										"http://172.21.50.3:8080/emit/feature/create",
																										feature_data)
																								.then(
																										function(
																												success) {
																										},
																										function(
																												error) {
																											/* error_flag = true; */
																										}));
																			});
																	$q
																	.all([ feature_crea ])
																	.then(
																			function(values) {
																				alert("Instrument updated");
																				$scope
																						.clean();
																			});																
																});
											});
						}

						$scope.remove = function(instrument) {
							$scope.instrument = instrument;
							$('#modal').modal('show');
						}

						$scope.erase = function() {
							$('#modal').modal('hide');
							var can_delete = true;
							var uri = $scope.instrument.uri;
							angular.forEach($scope.measurementsetlist,
									function(value) {
										if (value.instrument == uri) {
											can_delete = false;
										}
									});
							if (can_delete == true) {
								var data = {
									uri : uri
								};
								var data_feature = {
									instrument : uri
								};
								var feature_delete = $http
										.post(
												"http://172.21.50.3:8080/emit/feature/delete-one-instrument",
												data_feature).then(
												function(success) {
												}, function(error) {
												});
								$q
										.all([ feature_delete ])
										.then(
												function(values) {
													$http
															.post(
																	"http://172.21.50.3:8080/emit/instrument/delete",
																	data)
															.then(
																	function(
																			success) {
																		alert("Instrument deleted");
																		init();
																		$scope.size = 0;
																		$scope.offset = 0;
																		size();
																		page();
																	},
																	function(
																			error) {
																		alert("An error occured during deleting of the instrument.");
																	});
												});
							} else {
								alert("This " + element + " can't be deleted");
							}
						}

						var size = function() {
							$http
									.get(
											"http://172.21.50.3:8080/emit/instrument/size")
									.then(function(success) {
										$scope.size = success.data;
									}, function(error) {
										$scope.size = 0;
									});
						}
						var page = function() {
							$http
									.get(
											"http://172.21.50.3:8080/emit/instrument/page",
											{
												"params" : {
													"offset" : $scope.offset
												}
											}).then(function(success) {
										$scope.instruments = success.data;
									}, function(error) {
										$scope.instruments = [];
									});
						}
						$scope.prev = function() {
							if ($scope.length <= $scope.offset) {
								$scope.offset = $scope.offset - $scope.length;
								page();
							}
						}
						$scope.next = function() {
							if ($scope.offset + $scope.length < $scope.size) {
								$scope.offset = $scope.offset + $scope.length;
								page();
							}
						}
						$scope.first = function() {
							$scope.offset = 0;
							page();
						}
						$scope.last = function() {
							$scope.offset = Math.floor(($scope.size - 1)
									/ $scope.length)
									* $scope.length;
							page();
						}

						$scope.add_feature = function(selected_measure) {
							var msg = "";
							var error_name = false;
							var error_no_order = false;
							angular.forEach($scope.features, function(value,
									key) {
								if (value.no_order == $scope.feature.no_order) {
									error_no_order = true;
								}
								if (value.name == $scope.feature.name) {
									error_name = true;
								}
							});
							if (error_no_order == true || error_name == true) {
								var msg = "The feature can't be added :";
								if (error_name == true) {
									msg = msg + "\n- This name already exists";
								}
								if (error_no_order == true) {
									msg = msg + "\n- This order already exists";
								}
								alert(msg);
							} else {
								var data = {
									name : $scope.feature.name,
									no_order : $scope.feature.no_order,
									factor : $scope.feature.factor,
									measure : selected_measure.name
								};
								//console.log(data);
								console.log("no_order --> "
										+ $scope.feature.no_order);
								$scope.features.push(data);
								//console.log($scope.features);
							}
						}

						$scope.delete_feature = function(feature_name) {
							//console.log($scope.features);
							$scope.features = $scope.features.filter(function(
									feature) {
								return feature.name !== feature_name;
							});
							//	console.log($scope.features);
						}

						init();
						size();
						page();

					});
</script>
<body ng-app="app" ng-controller="controller">

	<header>
		<div class="navbar navbar-default navbar-custom navbar-static-top"
			id="navigation_barre">
			<div class="container">
				<a href="./index.html" class="navbar-brand" id="titre_appli">EMIT</a>
				<ul id="menu">
					<li class="active primaire"><a href="./index.html"
						class="primaire"><span class="glyphicon glyphicon-home">&ensp;</span>
							Home</a></li>

					<li class="dropdown primaire"><a href="#"
						class="dropdown-toggle primaire" data-toggle="dropdown"
						role="button" aria-expanded="false"><span
							class="glyphicon glyphicon-pushpin">&ensp;</span> Elements<span
							class="caret"></span></a>
						<ul class="dropdown-menu">
							<li><a href="./Instrument.html">Instruments</a></li>
							<li><a href="./Environment.html">Environments</a></li>
							<li><a href="./Measurand.html">Measurands</a></li>
							<li><a href="./Measure.html">Measures</a></li>
						</ul></li>
					<li class="active primaire"><a href="./CreateExperiment.html"
						class="primaire"><span class="glyphicon glyphicon-plus">&ensp;</span>Add
							experiment</a></li>
					<li class="active primaire"><a href="./test.html"
						class="primaire"><span class="glyphicon glyphicon-dashboard">&ensp;</span>
							Test</a></li>
				</ul>


			</div>
		</div>
	</header>

	<div id = "content" class="container">
		<section id="search" class="col-md-4">
			<form class="form" name="form" ng-if="selected">
				<fieldset>
					<legend ng-if="creating">Creation of a new instrument</legend>
					<legend ng-if="updating">Updating an instrument
						{{old_name}}</legend>
					<div class="form-group">
						<label for="instrument.uri">URI of the instrument</label> <input
							type="text" id="instrument.uri" class="form-control"
							ng-model="instrument.uri" placeholder="URI" required
							ng-required="true" />
					</div>
					<div class="form-group">
						<label for="instrument.name">Name</label> <input type="text"
							id="instrument.name" class="form-control"
							ng-model="instrument.name" placeholder="Name" ng-required="true" />
					</div>
					<legend>Linked features</legend>
					<div class="form-group">
						<label for="feature.name">Name</label> <input type="text"
							id="feature.name" class="form-control" ng-model="feature.name"
							placeholder="Name" />
					</div>
					<div class="form-group">
						<label for="measure.name">Measure</label> <select
							id="measure.name" class="form-control selectpicker"
							ng-options="measure.name for measure in measures"
							ng-model="selected_measure" title="Available measures">
							<option value="" disabled>-- Choose a measure --</option>
						</select>
					</div>
					<div class="form-group">
						<label for="feature.factor">Factor</label> <select
							id="feature.factor" class="form-control"
							ng-model="feature.factor" title="Factor">
							<option value="12" label="12 = tera">
							<option value="9" label="9 = giga">
							<option value="6" label="6 = mega">
							<option value="3" label="3 = kilo">
							<option value="2" label="2 = hecto">
							<option value="1" label="1 = deka	">
							<option value="0" label="0 = no factor" selected="selected">
							<option value="-1" label="- 1 = deci">
							<option value="-2" label="- 2 = centi">
							<option value="-3" label="- 3 = milli">
							<option value="-6" label="- 6 = micro">
							<option value="-9" label="- 9 = nano">
							<option value="-12" label="- 12 = pico">
						</select>
						<div class="form-group">
							<label for="feature.no_order">Column order</label><input
								id="feature.no_order" class="form-control" type="number"
								ng-model="feature.no_order" title="Order" value="1" min="1">
						</div>
					</div>
					<div class="form-group">
						<button type="button" class="btn btn-default"
							ng-click="add_feature(selected_measure)">
							<span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
							Add feature
						</button>
					</div>

					<div class="table-responsive" ng-if = "features.length > 0">
						<table class="table">
							<thead>
								<tr>
									<th>Order</th>
									<th>Name</th>
									<th>Measure</th>
									<th>Factor</th>
								</tr>
							</thead>
							<tbody>
								<tr ng-repeat="feature in features | orderBy : 'no_order'">
									<td>{{feature.no_order}}</td>
									<td>{{feature.name}}</td>
									<td>{{feature.measure}}</td>
									<td>{{feature.factor}}</td>
									<td><button type="button" class="btn btn-default"
											ng-click="delete_feature(feature.name)">
											<span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
										</button></td>
								</tr>
							</tbody>
						</table>
					</div>

					<div class="form-group pull-right">
						<button type="reset" class="btn btn-default" ng-click="clean()">
							<strong>Cancel</strong>
						</button>
						<button type="submit" class="btn"
							ng-click="form.$valid && update()" ng-disabled="form.$invalid"
							ng-if="updating">
							<strong>Modify</strong>
						</button>
						<button type="submit" class="btn"
							ng-click="form.$valid && create()" ng-disabled="form.$invalid"
							ng-if="creating">
							<strong>Add</strong>
						</button>
					</div>
				</fieldset>
			</form>
		</section>
		<section id="results" class="col-md-8">
			<h2>
				Instruments <small>({{size}} elements)</small>
			</h2>
			<nav aria-label="...">
				<ul class="pager">
					<li class="previous"><a class="btn btn-default"
						ng-click="first()"><span aria-hidden="true"
							class="glyphicon glyphicon-step-backward"></span> </a></li>
					<li class="previous"><a class="btn btn-default"
						ng-click="prev()"><span aria-hidden="true"
							class="glyphicon glyphicon-chevron-left"></span></a></li>
					<li ng-if="size > 0">{{(offset / length) + 1 | ceil}} / {{size
						/ length | ceil}}</li>
					<li class="next"><a class="btn btn-default" ng-click="last()"><span
							aria-hidden="true" class="glyphicon glyphicon-step-forward"></span></a></li>
					<li class="next"><a class="btn btn-default" ng-click="next()"><span
							aria-hidden="true" class="glyphicon glyphicon-chevron-right"></span></a></li>
				</ul>
			</nav>
			<ul class="list-group" ng-repeat="instrument in instruments">
				<li class="list-group-item">
					<p class="list-group-item-heading">{{instrument.name}}</p>
					<p class="list-group-item-text">
						<span ng-if="instrument.uri">{{instrument.uri}} </span>
					</p>
					<p class="list-group-item-text text-right">
						<button type="button" class="btn btn-default"
							ng-click="remove(instrument)">
							<span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
						</button>
						<span>&nbsp;</span>
						<button type="button" class="btn btn-default"
							ng-click="select(instrument)">
							<span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
						</button>
					</p>
				</li>
			</ul>
			<div class="pull-right">
				<button type="button" class="btn btn-info pull-right"
					ng-click="select()">
					<span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
				</button>
			</div>
		</section>
	</div>
	<div id="modal" class="modal fade" tabindex="-1" role="dialog">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h4 class="modal-title">Deleting an instrument</h4>
				</div>
				<div class="modal-body">
					<p>Do you really want to delete : {{instrument.name}}&nbsp;?</p>
					<p>URI&nbsp;: {{instrument.uri}}</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
					<button type="button" class="btn" ng-click="erase()">Confirm</button>
				</div>
			</div>
		</div>
	</div>
	<footer id = "footer">
        <div class="container">
          <div class="row">
            <div class="col-md-4">
            	<br>
              	<span class="text-left">Copyright © 2015-2017. ICAM. Tous droits réservés.</span>
            </div>
            <div class="col-md-4">
           		<a href="https://www.icam.fr/icam/les-campus-icam/icam-site-de-nantes" target="_blank"><img class="center-block" src="./png/icam.png" height="60" alt="Icam" /></a>
            </div>  
            <div class="col-md-4"> 
              <div class="text-right">
              <br>
                <a href="https://www.facebook.com/icam.nantes" target="_blank"><i class="fa fa-facebook-square fa-2x text-muted"></i></a>
                <span>&emsp;</span>
                <a href="https://twitter.com/icam_fr" target="_blank"><i class="fa fa-twitter fa-2x text-muted"></i></a>
                <span>&emsp;</span>
                <a href="https://plus.google.com/118426909654384683619/about" target="_blank"><i class="fa fa-google-plus fa-2x text-muted"></i></a>
                <span>&emsp;</span>
                <a href="https://www.linkedin.com/company/icam-institut-catholique-d%27arts-et-metiers" target="_blank"><i class="fa fa-linkedin fa-2x text-muted"></i></a>
                <span>&emsp;</span>
                <a href="https://www.youtube.com/channel/UCQbkQwnly-uMpHTdudW8ocw"  target="_blank"><i class="fa fa-youtube fa-2x text-muted"></i></a>
              </div>
            </div>
          </div>
        </div>
    </footer>
</body>
</html>
