<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>EMIT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<link href="css/sb-admin-2.css" rel="stylesheet">
</head>
<script type="text/javascript"
	src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script type="text/javascript"
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript"
	src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.2/angular.min.js"></script>
<script type="text/javascript">
	var app = angular.module('app', []);
	var old_unit;
	var old_name;

	app.filter('ceil', function() {
		return function(input) {
			return Math.ceil(input);
		};
	});

	app
			.controller(
					'controller',
					function($scope, $http) {

						$http
								.get(
										"http://172.21.50.3:8080/emit/measure/list")
								.then(function(response) {
									$scope.measurelist = response.data;
								});

						var empty = {};

						$scope.selected = false;
						$scope.creating = false;
						$scope.updating = false;

						$scope.alert = {};
						$scope.measure = {};
						$scope.measures = [];
						$scope.size = 0;
						$scope.offset = 0;
						$scope.length = 5;

						var init = function() {
							$scope.selected = false;
							$scope.creating = false;
							$scope.updating = false;
							$scope.measure = angular.copy(empty);
						}
						$scope.clean = function() {
							init();
						}
						$scope.select = function(measure) {
							if (measure) {
								$scope.creating = false;
								$scope.updating = true;
								$scope.measure = measure;
								old_name = measure.name;
								old_unit = measure.unit;
								$scope.old_unit = old_unit;

							} else {
								$scope.creating = true;
								$scope.updating = false;
							}
							$scope.selected = true;
						}
						$scope.create = function() {

							var indata = {
								name : $scope.measure.name,
								unit : $scope.measure.unit
							};
							$http
									.post(
											"http://172.21.50.3:8080/emit/measure/create",
											indata)
									.then(
											function(success) {
												alert("Measure created");
												init();
												$scope.size = 0;
												$scope.offset = 0;
												size();
												page();
											},
											function(error) {
												alert("An error occured during creation of the measure.");
											});
						}
						$scope.update = function() {
							var indata = [ {
								name : old_name,
								unit : old_unit
							}, {
								name : $scope.measure.name,
								unit : $scope.measure.unit
							} ];

							$http
									.post(
											"http://172.21.50.3:8080/emit/measure/update",
											indata)
									.then(
											function(success) {
												alert("Measure updated");
											},
											function(error) {
												alert("An error occured during updating of the measure.");
											});
							$scope.clean();
						}

						$scope.remove = function(measure) {
							$scope.measure = measure;
							$('#modal').modal('show');
						}

						$scope.erase = function() {
							$('#modal').modal('hide');
							var can_delete = true;
							var name = $scope.measure.name;
							angular.forEach($scope.measurelist,
									function(value) {
										if (value.measure == name) {
											can_delete = false;
										}
									});
							if (can_delete == true) {
								var data = {
									name : name
								};
								$http
										.post(
												"http://172.21.50.3:8080/emit/measure/delete",
												data)
										.then(
												function(success) {
													alert("Measure deleted");
													init();
													$scope.size = 0;
													$scope.offset = 0;
													size();
													page();
												},
												function(error) {
													alert("An error occured during deleting of the measure.");
												});
							} else {
								alert("This " + element + " can't be deleted");
							}
						}

						var size = function() {
							$http
									.get(
											"http://172.21.50.3:8080/emit/measure/size")
									.then(function(success) {
										$scope.size = success.data;
									}, function(error) {
										$scope.size = 0;
									});
						}
						var page = function() {
							$http
									.get(
											"http://172.21.50.3:8080/emit/measure/page",
											{
												"params" : {
													"offset" : $scope.offset
												}
											}).then(function(success) {
										$scope.measures = success.data;
									}, function(error) {
										$scope.measures = [];
									});
						}
						$scope.prev = function() {
							if ($scope.length <= $scope.offset) {
								$scope.offset = $scope.offset - $scope.length;
								page();
							}
						}
						$scope.next = function() {
							if ($scope.offset + $scope.length < $scope.size) {
								$scope.offset = $scope.offset + $scope.length;
								page();
							}
						}
						$scope.first = function() {
							$scope.offset = 0;
							page();
						}
						$scope.last = function() {
							$scope.offset = Math.floor(($scope.size - 1)
									/ $scope.length)
									* $scope.length;
							page();
						}

						init();
						size();
						page();

					});
</script>
<body ng-app="app" ng-controller="controller">

	<header>
		<div class="navbar navbar-default navbar-custom navbar-static-top"
			id="navigation_barre">
			<div class="container">
				<button type="button" class="navbar-toggle" data-toggle="collapse"
					data-target=".navbar-collapse">
					<span class="sr-only">Toggle navigation</span> <span
						class="icon-bar"></span> <span class="icon-bar"></span> <span
						class="icon-bar"></span>
				</button>
				<a href="./index.html" class="navbar-brand" id="titre_appli">EMIT</a>
				<ul id="menu">
					<li class="active primaire"><a href="./index.html"
						class="primaire"><span class="glyphicon glyphicon-home">&ensp;</span>
							Home</a></li>

					<li class="dropdown primaire"><a href="#"
						class="dropdown-toggle primaire" data-toggle="dropdown"
						role="button" aria-expanded="false"><span
							class="glyphicon glyphicon-pushpin">&ensp;</span> Elements<span
							class="caret"></span></a>
						<ul class="dropdown-menu">
							<li><a href="./Instrument.html">Instruments</a></li>
							<li><a href="./Environment.html">Environments</a></li>
							<li><a href="./Measurand.html">Measurands</a></li>
							<li><a href="./Measure.html">Measures</a></li>
						</ul></li>
					<li class="active primaire"><a href="./CreateExperiment.html"
						class="primaire"><span class="glyphicon glyphicon-plus">&ensp;</span>Add
							experiment</a></li>
					<li class="active primaire"><a href="./test.html"
						class="primaire"><span class="glyphicon glyphicon-dashboard">&ensp;</span>
							Test</a></li>
				</ul>


			</div>
		</div>
	</header>

	<div class="container">
		<br>
		<br>
		<br>
		<section id="search" class="col-md-4">
			<br>
			<br>
			<form class="form" role="form" name="form" ng-if="selected">
				<fieldset>
					<legend ng-if="creating">Creation of a new measure</legend>
					<legend ng-if="updating">Updating an measure
						{{old_name}}</legend>
					<div class="form-group">
						<label for="measure.name">Name of the measure</label> <input
							type="text" id="measure.name" class="form-control"
							ng-model="measure.name" placeholder="Name" required
							ng-required="true" />
					</div>
					<div class="form-group">
						<label for="measure.unit">Unit</label> <input type="text"
							id="measure.unit" class="form-control"
							ng-model="measure.unit" placeholder="Unit" ng-required="true" />
					</div>
					<div class="form-group pull-right">
						<button type="reset" class="btn btn-default" ng-click="clean()">
							<strong>Cancel</strong>
						</button>
						<button type="submit" class="btn"
							ng-click="form.$valid && update()" ng-disabled="form.$invalid"
							ng-if="updating">
							<strong>Modify</strong>
						</button>
						<button type="submit" class="btn"
							ng-click="form.$valid && create()" ng-disabled="form.$invalid"
							ng-if="creating">
							<strong>Add</strong>
						</button>
					</div>
				</fieldset>
			</form>
		</section>
		<section id="results" class="col-md-8">
			<h2>
				Measures <small>({{size}} elements)</small>
			</h2>
			<nav aria-label="...">
				<ul class="pager">
					<li class="previous"><a class="btn btn-default"
						ng-click="first()"><span aria-hidden="true"
							class="glyphicon glyphicon-step-backward"></span> </a></li>
					<li class="previous"><a class="btn btn-default"
						ng-click="prev()"><span aria-hidden="true"
							class="glyphicon glyphicon-chevron-left"></span></a></li>
					<li ng-if="size > 0">{{(offset / length) + 1 | ceil}} / {{size
						/ length | ceil}}</li>
					<li class="next"><a class="btn btn-default" ng-click="last()"><span
							aria-hidden="true" class="glyphicon glyphicon-step-forward"></span></a></li>
					<li class="next"><a class="btn btn-default" ng-click="next()"><span
							aria-hidden="true" class="glyphicon glyphicon-chevron-right"></span></a></li>
				</ul>
			</nav>
			<ul class="list-group" ng-repeat="measure in measures">
				<li class="list-group-item">
					<p class="list-group-item-heading">{{measure.unit}}</p>
					<p class="list-group-item-text">
						<span ng-if="measure.name">{{measure.name}} </span>
					</p>
					<p class="list-group-item-text text-right">
						<button type="button" class="btn btn-default"
							ng-click="remove(measure)">
							<span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
						</button>
						<span>&nbsp;</span>
						<button type="button" class="btn btn-default"
							ng-click="select(measure)">
							<span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
						</button>
					</p>
				</li>
			</ul>
			<div class="">
				<button type="button" class="btn btn-info pull-right"
					ng-click="select()">
					<span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
				</button>
			</div>
		</section>
	</div>
	<div id="modal" class="modal fade" tabindex="-1" role="dialog">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h4 class="modal-title">Deleting a measure</h4>
				</div>
				<div class="modal-body">
					<p>Do you really want to delete : {{measure.name}}&nbsp;?</p>
					<p>Unit&nbsp;: {{measure.unit}}</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
					<button type="button" class="btn" ng-click="erase()">Confirm</button>
				</div>
			</div>
		</div>
	</div>
</body>
</html>
