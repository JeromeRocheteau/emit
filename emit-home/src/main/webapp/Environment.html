<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>EMIT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<link rel="stylesheet" href="./css/font-awesome.min.css">
<link href="css/sb-admin-2.css" rel="stylesheet">
</head>
<script type="text/javascript"
	src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script type="text/javascript"
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript" src="DJS/moment.min.js"></script>
<script type="text/javascript" src="DJS/moment.fr.js"></script>
<script type="text/javascript" src="https://code.angularjs.org/1.6.3/angular.min.js"></script>
<script type="text/javascript" src="https://code.angularjs.org/1.6.3/angular-cookies.min.js"></script>
<script type="text/javascript" src="https://code.angularjs.org/1.6.3/angular-sanitize.min.js"></script>
<script type="text/javascript" src="https://code.angularjs.org/1.6.3/i18n/angular-locale_fr-fr.js"></script>
<script type="text/javascript">
	var app = angular.module('app', ['ngSanitize','ngCookies']);
	var old_uri;
	var old_name;

	app.filter('ceil', function() {
		return function(input) {
			return Math.ceil(input);
		};
	});

	app
			.controller(
					'controller',
					function($scope, $http, $cookieStore) {

						$scope.passphrase = $cookieStore.get('passphrase');
						$scope.logout = function() {
							$http
									.post(
											"http://172.21.50.3:8080/emit-users/revoke?passphrase=" + $scope.passphrase).then(function(success) {
									}, function(error) {
									});
							$cookieStore.remove('passphrase');
							$scope.passphrase = null;
						}
						$scope.profile = null;
						var profile = function() {
							if ($scope.passphrase) {
								$http
										.post(
												"http://172.21.50.3:8080/emit-users/profile?passphrase=" + $scope.passphrase)
										.then(
												function(success) {
													$scope.profile = success.data;
													$scope.firstname = $scope.profile.firstname;
													$scope.lastname = $scope.profile.lastname;
												}, function(error) {
													$scope.profile = null;
												});
							}
						}
						
						$http.get(
								"http://172.21.50.3:8080/emit/experiment/list")
								.then(function(response) {
									$scope.experimentlist = response.data;
								});

						var empty = {};

						$scope.selected = false;
						$scope.creating = false;
						$scope.updating = false;

						$scope.alert = {};
						$scope.environment = {};
						$scope.environments = [];
						$scope.size = 0;
						$scope.offset = 0;
						$scope.length = 5;

						var init = function() {
							$scope.selected = false;
							$scope.creating = false;
							$scope.updating = false;
							$scope.environment = angular.copy(empty);
						}
						$scope.clean = function() {
							init();
						}
						$scope.select = function(environment) {
							if (environment) {
								$scope.creating = false;
								$scope.updating = true;
								$scope.environment = environment;
								old_uri = environment.uri;
								old_name = environment.name;
								$scope.old_name = old_name;
							} else {
								$scope.creating = true;
								$scope.updating = false;
							}
							$scope.selected = true;
						}
						$scope.create = function() {
							var indata = {
								uri : $scope.environment.uri,
								name : $scope.environment.name
							};
							$http
									.post(
											"http://172.21.50.3:8080/emit/environment/create",
											indata)
									.then(
											function(success) {
												alert("Environnement created");
												init();
												$scope.size = 0;
												$scope.offset = 0;
												size();
												page();
											},
											function(error) {
												alert("An error occured during creation of the Environnement.");
											});
						}
						$scope.update = function() {
							var indata = [ {
								uri : old_uri,
								name : old_name
							}, {
								uri : $scope.environment.uri,
								name : $scope.environment.name
							} ];

							$http
									.post(
											"http://172.21.50.3:8080/emit/environment/update",
											indata)
									.then(
											function(success) {
												alert("Environnement updated");
											},
											function(error) {
												alert("An error occured during updating of the Environnement.");
											});
							$scope.clean();
						}

						$scope.remove = function(environment) {
							$scope.environment = environment;
							$('#modal').modal('show');
						}

						$scope.erase = function() {
							$('#modal').modal('hide');
							var can_delete = true;
							var uri = $scope.environment.uri;
							angular.forEach($scope.experimentlist, function(
									value) {
								if (value.environment == uri) {
									can_delete = false;
								}
							});
							if (can_delete == true) {
								var data = {
									uri : uri
								};
								$http
										.post(
												"http://172.21.50.3:8080/emit/environment/delete",
												data)
										.then(
												function(success) {
													alert("Environnement deleted");
													init();
													$scope.size = 0;
													$scope.offset = 0;
													size();
													page();
												},
												function(error) {
													alert("An error occured during deleting of the Environnement.");
												});
							} else {
								alert("This " + element + " can't be deleted");
							}
						}
						var size = function() {
							$http
									.get(
											"http://172.21.50.3:8080/emit/environment/size")
									.then(function(success) {
										$scope.size = success.data;
									}, function(error) {
										$scope.size = 0;
									});
						}
						var page = function() {
							$http
									.get(
											"http://172.21.50.3:8080/emit/environment/page",
											{
												"params" : {
													"offset" : $scope.offset
												}
											}).then(function(success) {
										$scope.environments = success.data;
									}, function(error) {
										$scope.environments = [];
									});
						}
						$scope.prev = function() {
							if ($scope.length <= $scope.offset) {
								$scope.offset = $scope.offset - $scope.length;
								page();
							}
						}
						$scope.next = function() {
							if ($scope.offset + $scope.length < $scope.size) {
								$scope.offset = $scope.offset + $scope.length;
								page();
							}
						}
						$scope.first = function() {
							$scope.offset = 0;
							page();
						}
						$scope.last = function() {
							$scope.offset = Math.floor(($scope.size - 1)
									/ $scope.length)
									* $scope.length;
							page();
						}
						
						profile();
						init();
						size();
						page();

					});
</script>
<body ng-app="app" ng-controller="controller">
	<header>
		<div class="navbar navbar-default navbar-custom navbar-static-top"
			id="navigation_barre">
			<div class="container">
				<a href="./index.html" class="navbar-brand" id="titre_appli">EMIT</a>
				<ul id="menu">
					<li class="active primaire"><a href="./index.html"
						class="primaire"><span class="glyphicon glyphicon-home">&ensp;</span>
							Home</a></li>
					<li class="dropdown primaire"><a href="#"
						class="dropdown-toggle primaire" data-toggle="dropdown"
						role="button" aria-expanded="false"><span
							class="glyphicon glyphicon-pushpin">&ensp;</span> Elements<span
							class="caret"></span></a>
						<ul class="dropdown-menu">
							<li><a href="./Instrument.html">Instruments</a></li>
							<li><a href="./Environment.html">Environments</a></li>
							<li><a href="./Measurand.html">Measurands</a></li>
							<li><a href="./Measure.html">Measures</a></li>
							<li><a href="./Analysis.html">Analyses</a></li>
						</ul></li>
					<li class="active primaire"><a href="./CreateExperiment.html"
						class="primaire"><span class="glyphicon glyphicon-plus">&ensp;</span>Add
							experiment</a></li>
					<li class="active primaire"><a href="./CreateAnalysis.html"
						class="primaire"><span class="glyphicon glyphicon-tasks">&ensp;</span>
							Plan analysis</a></li>
					<li class="dropdown primaire"><a href="#"
						class="dropdown-toggle primaire" data-toggle="dropdown"
						role="button" aria-expanded="false"><span
							class="glyphicon glyphicon-user">&ensp;</span> User<span
							class="caret"></span></a>
						<ul class="dropdown-menu">
							<li class="dropdown-header" ng-if="profile">{{profile.firstname}}
								{{profile.lastname}}</li>
							<li ng-if="passphrase"><a href="./settings.html""><span class="glyphicon glyphicon-cog">&ensp;</span> Parameters</a></li>
							<li ng-if="passphrase"><a href="./index.html"
								ng-click="logout()"><span class="glyphicon glyphicon-log-out">&ensp;</span> Log out</a></li>
							<li ng-if="!passphrase"><a href="./sign-in.html"><span class="glyphicon glyphicon-log-in">&ensp;</span> Log in</a></li>
							<li ng-if="!passphrase"><a href="./sign-up.html"><span class="glyphicon glyphicon-edit">&ensp;</span> Register</a></li>
						</ul></li>
				</ul>
			</div>
		</div>
	</header>

	<div id="content" class="container">
	<div class="alert alert-danger" role="alert" ng-if="!passphrase">
			<strong>No Access !</strong> You have to <a href="./sign-in.html">log in</a> before visualize this page. 
		</div>
		<section id="search" class="col-md-4" ng-if="passphrase">
			<form class="form" name="form" ng-if="selected">
				<fieldset>
					<legend ng-if="creating">Creation of a new Environment</legend>
					<legend ng-if="updating">Updating an Environment
						{{old.name}}</legend>
					<div class="form-group">
						<label for="environment.uri">URI of the Environment</label> <input
							type="text" id="environment.uri" class="form-control"
							ng-model="environment.uri" placeholder="URI" required
							ng-required="true" />
					</div>
					<div class="form-group">
						<label for="environment.name">Name</label> <input type="text"
							id="environment.name" class="form-control"
							ng-model="environment.name" placeholder="Name" ng-required="true" />
					</div>
					<div class="form-group pull-right">
						<button type="reset" class="btn btn-default" ng-click="clean()">
							<strong>Cancel</strong>
						</button>
						<button type="submit" class="btn"
							ng-click="form.$valid && update()" ng-disabled="form.$invalid"
							ng-if="updating">
							<strong>Modify</strong>
						</button>
						<button type="submit" class="btn"
							ng-click="form.$valid && create()" ng-disabled="form.$invalid"
							ng-if="creating">
							<strong>Add</strong>
						</button>
					</div>
				</fieldset>
			</form>
		</section>
		<section id="results" class="col-md-8" ng-if="passphrase">
			<h2>
				Environments <small>({{size}} elements)</small>
			</h2>
			<nav aria-label="...">
				<ul class="pager">
					<li class="previous"><a class="btn btn-default"
						ng-click="first()"><span aria-hidden="true"
							class="glyphicon glyphicon-step-backward"></span> </a></li>
					<li class="previous"><a class="btn btn-default"
						ng-click="prev()"><span aria-hidden="true"
							class="glyphicon glyphicon-chevron-left"></span></a></li>
					<li ng-if="size > 0">{{(offset / length) + 1 | ceil}} / {{size
						/ length | ceil}}</li>
					<li class="next"><a class="btn btn-default" ng-click="last()"><span
							aria-hidden="true" class="glyphicon glyphicon-step-forward"></span></a></li>
					<li class="next"><a class="btn btn-default" ng-click="next()"><span
							aria-hidden="true" class="glyphicon glyphicon-chevron-right"></span></a></li>
				</ul>
			</nav>
			<ul class="list-group" ng-repeat="environment in environments">
				<li class="list-group-item">
					<p class="list-group-item-heading">{{environment.name}}</p>
					<p class="list-group-item-text">
						<span ng-if="environment.uri">{{environment.uri}} </span>
					</p>
					<p class="list-group-item-text text-right">
						<button type="button" class="btn btn-default"
							ng-click="remove(environment)">
							<span class="glyphicon glyphicon-trash" aria-hidden="true"></span>
						</button>
						<span>&nbsp;</span>
						<button type="button" class="btn btn-default"
							ng-click="select(environment)">
							<span class="glyphicon glyphicon-pencil" aria-hidden="true"></span>
						</button>
					</p>
				</li>
			</ul>
			<div class="pull-right">
				<button type="button" class="btn btn-info pull-right"
					ng-click="select()">
					<span class="glyphicon glyphicon-plus" aria-hidden="true"></span>
				</button>
			</div>
		</section>
	</div>
	<div id="modal" class="modal fade" tabindex="-1" role="dialog">
		<div class="modal-dialog" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
					<h4 class="modal-title">Deleting an Environment</h4>
				</div>
				<div class="modal-body">
					<p>Do you really want to delete : {{environment.name}}&nbsp;?</p>
					<p>URI&nbsp;: {{environment.uri}}</p>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
					<button type="button" class="btn" ng-click="erase()">Confirm</button>
				</div>
			</div>
		</div>
	</div>
	<footer id="footer">
		<div class="container">
			<div class="row">
				<div class="col-md-4">
					<br> <span class="text-left">Copyright © 2015-2017.
						ICAM. Tous droits réservés.</span>
				</div>
				<div class="col-md-4">
					<a
						href="https://www.icam.fr/icam/les-campus-icam/icam-site-de-nantes"
						target="_blank"><img class="center-block" src="./png/icam.png"
						height="45" alt="Icam" /></a>
				</div>
				<div class="col-md-4">
					<div class="text-right">
						<br> <a href="https://www.facebook.com/icam.nantes"
							target="_blank"><i
							class="fa fa-facebook-square fa-2x text-muted"></i></a> <span>&emsp;</span>
						<a href="https://twitter.com/icam_fr" target="_blank"><i
							class="fa fa-twitter fa-2x text-muted"></i></a> <span>&emsp;</span> <a
							href="https://plus.google.com/118426909654384683619/about"
							target="_blank"><i class="fa fa-google-plus fa-2x text-muted"></i></a>
						<span>&emsp;</span> <a
							href="https://www.linkedin.com/company/icam-institut-catholique-d%27arts-et-metiers"
							target="_blank"><i class="fa fa-linkedin fa-2x text-muted"></i></a>
						<span>&emsp;</span> <a
							href="https://www.youtube.com/channel/UCQbkQwnly-uMpHTdudW8ocw"
							target="_blank"><i class="fa fa-youtube fa-2x text-muted"></i></a>
					</div>
				</div>
			</div>
		</div>
	</footer>
</body>
</html>