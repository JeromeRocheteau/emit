<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>EMIT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	


<link href="css/sb-admin-2.css" rel="stylesheet">
<link href="css/bootstrap-treeview.css" rel="stylesheet">

   
</head>

<script type="text/javascript" src="DJS/Chart.min.js"></script>
<script type="text/javascript"
	src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script type="text/javascript"
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript"
	src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.2/angular.min.js"></script>
<script type="text/javascript" src="DJS/angular-chart.min.js"></script>

<script type="text/javascript" src="DJS/sb-admin-2.js"></script>
<script type="text/javascript" src="DJS/bootstrap-treeview.js"></script>
<script type="text/javascript">
	
	
	var app = angular.module('app', [ 'chart.js' ]);	
	// tableau de navigation des items et ses variables	
	var tree = [];
	
	
	
	
	
	app.controller('myCtrl', function($scope, $http,$q) {	
		
		
		$scope.retrive_instrument_name = function(uri){
			var name ="";
			angular.forEach($scope.instrumentlist, function(value) {//$scope.measurandlist
				if(uri == value.uri){
					name = value.name;
				}
			});
			return name;
		}
		
		$scope.retrive_measure_name = function(measure){
			var name ="";
			angular.forEach($scope.measurelist, function(value) {//$scope.measurandlist
				if(measure == value.name){
					name = value.name;
				}
			});
			return name;
		}
		
		
		var initSelectableTree = function() {
	          return $('#tree').treeview({
	            data: tree,
	            multiSelect: false,
	            onNodeSelected: function(event, node) {
	             console.log(node.id +' was selected')
	             switch(node.id){
	             case "measurand":fillExperiment(node);
	             break;
	             case"experiment":{
	            	 console.log('resultat en cour de saisie');
	            	 fillMeasurementSet(node);	            	 
	             }break;
	             case"measurementSet":fillMeasurement(node);	             
	             break;
	             case"measurement":$scope.afficher_test(node.key);
	             
	             break;
	             }
	             
	             //$scope.afficher_test(node.text);
	            },
	            onNodeUnselected: function (event, node) {
	             
	            }
	          });
	        };
	        
	       
	        	
	        
		
			
			
			
			function fillMeasurement(node){
				console.log('debut de la fonction');
				node.selectable  = false;				
				node.state= { expanded: true };
				var $selectableTree = initSelectableTree();
				var temp = [];
				
				$http.get("http://172.21.1.18/emit/measurement/list",
						{
							"params" : {
								"fkey" :node.key
							}
						}).then(function(success) {
							var measurement =success.data;
							
							var i = 0;
							angular.forEach(measurement, function(value){
								
								var data = {										
									
									count:i,									
									text:$scope.retrive_measure_name(value.measure),
									color:"black",
									key:value.data,
									id:"measurement",
									selectable:true,									
									state: { expanded: false },	
									nodes:""
								}
								temp[i] = data;
								i++;								
							});
						node.nodes = temp;
						tree[node.measurand].nodes[node.experiment].nodes[node.count] =node; 	
						var $selectableTree = initSelectableTree();
						console.log("objet intéréssant");
						
						});
			
			}
			
			function fillMeasurementSet(node){
				console.log('debut de la fonction');
				node.selectable  = false;				
				node.state= { expanded: true };
				var $selectableTree = initSelectableTree();
				var temp = [];
				
				$http.get("http://172.21.1.18/emit/measurementSet/list",
						{
							"params" : {
								"fkey" :node.key
							}
						}).then(function(success) {
							var measurementSet =success.data;
							
							var i = 0;
							angular.forEach(measurementSet, function(value){
								
								var data = {										
									measurand:node.measurand,
									experiment:node.count,
									count:i,									
									text:$scope.retrive_instrument_name(value.instrument),
									color:"black",
									key:value.id,
									id:"measurementSet",
									selectable:true,									
									state: { expanded: false },	
									nodes:""
								}
								temp[i] = data;
								i++;								
							});
						node.nodes = temp;
						tree[node.measurand].nodes[node.count] =node; 	
						var $selectableTree = initSelectableTree();	
						});
			
			}
			
			function fillExperiment(node){
				
				console.log('debut de la fonction');
				node.selectable  = false;				
				node.state= { expanded: true };
				var $selectableTree = initSelectableTree();
				var temp = [];
				$http.get("http://172.21.1.18/emit/experiment/list",
						{
							"params" : {
								"fkey" :node.key
							}
						}).then(function(success) {
							var experiment = success.data;
							var i = 0;
							angular.forEach(experiment, function(value){
								var data = {								
									measurand:node.count,
									count:i,
									text:value.started,
									color:"black",
									key:value.id,
									id:"experiment",
									selectable:true,									
									state: { expanded: false },	
									nodes:""
								}
								temp[i] = data;
								i++;
							});
							node.nodes= temp;
							console.log(angular.toJson(node));
							console.log(angular.toJson(tree));
							tree[node.count] = node;
							console.log('resultat final');
							console.log(angular.toJson(tree));
							var $selectableTree = initSelectableTree();
						});			
			};
			
			function fillMeasurand(){
				var i = 0;
				angular.forEach($scope.measurandlist, function(value){
					var data = {							
						count:i,
						text:value.name,
						color:"black",
						key:value.process,
						id:"measurand",
						selectable:true,						
						state: { expanded: false },
						nodes:""
					};				
					tree[i] =data;
					
					i++;
				});
				
				var $selectableTree = initSelectableTree();
				
			};
			
			
	

		$scope.refresh = function() {
			// déclaration des promesses (voir promises)
			var experiment = $http.get("http://172.21.1.18/emit/experiment/list");
			var instrument = $http.get("http://172.21.1.18/emit/instrument/list");
			var environment = $http.get("http://172.21.1.18/emit/environment/list");
			var measure = $http.get("http://172.21.1.18/emit/measure/list");
			var measurement = $http.get("http://172.21.1.18/emit/measurement/list");
			var measurand = $http.get("http://172.21.1.18/emit/measurand/list");
			var measurementset = $http.get("http://172.21.1.18/emit/measurementSet/list");
			
			// attente de la réalisation de toutes les promesses
			$q.all([experiment,instrument,environment,measure,measurement,measurand,measurementset]).then(function(values){
				//console.log(angular.toJson(values[0].data))
				$scope.experimentlist = values[0].data;
				$scope.instrumentlist = values[1].data;
				$scope.environmentlist= values[2].data;
				$scope.measurelist=values[3].data;
				$scope.measurementlist = values[4].data;
				$scope.measurandlist =  values[5].data;
				$scope.measurementsetlist = values[6].data;
				//réalisation des opérations souaitées
				fillMeasurand();
			});
		
		}

		$scope.refresh();

		$scope.afficher_test = function(file_name) {
			var retour_test = [];
			var serie = [];
			var serie1 = [];
			var globalSerie = [];

			$http.get(
					"http://172.21.1.18/emit/test/test?file_name=" + file_name)
					.then(function(response) {
						retour_test = response.data;
						//console.log(retour_test.length);

						for (var i = 0; i < retour_test.length; i++) {
							
							serie[i] = retour_test[i].x / 1000;
							serie1[i] = retour_test[i];						
							
							console.log(i);
							// renvois
						}

						$scope.loaded_file = "Loaded file : " + file_name;
						console.log(angular.toJson(serie1));
						globalSerie.push(serie1);

						$scope.labels = serie
						$scope.series = [ 'Series A' ];

						console.log(serie);

						$scope.data = globalSerie;
						$scope.onClick = function(points, evt) {
							console.log(points, evt);

						}
					});
		}

		$scope.modify = function(primarykey, info) {
			sessionStorage.setItem("primarykey", primarykey);
			sessionStorage.setItem("info", info);
		}
		$scope.deleteobject = function(element, adresse_delete, primarykey) {
			var can_delete = true;
			switch (element) {
			case 'instrument':
				angular.forEach($scope.measurementsetlist, function(value) {
					if (value.instrument == primarykey) {
						can_delete = false;
					}
				});
				break;
			case 'environment':
				angular.forEach($scope.experimentlist, function(value) {
					if (value.environment == primarykey) {
						can_delete = false;
					}
				});
				break;
			case 'measurement':
				angular.forEach($scope.experimentlist, function(value) {
					if (value.measurand == primarykey) {
						can_delete = false;
					}
				});
				break;
			default:
				alert("Not possible yet");
				can_delete = false;
			}

			if (can_delete == true) {
				var data = {
					uri : primarykey
				}
				var url_delete = "http://172.21.1.18/emit" + adresse_delete;
				$http.post(url_delete, data).then(function(response) {

				});
				alert("This " + element + " is deleted");
				$scope.refresh();
			} else {
				alert("This " + element + " can't be deleted");
			}

		}
	});
</script>
<body ng-app="app" ng-controller="myCtrl">
	<header>
		<div class="navbar navbar-default navbar-custom navbar-static-top" id="navigation_barre">
			<div class="container">
				 <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
				<a href="./index.html" class="navbar-brand" id = "titre_appli">EMIT</a>
				<ul id = "menu">
					<li class="active primaire"><a href="./index.html" class="primaire"><span
								class="glyphicon glyphicon-home">&ensp;</span> Home</a></li>
					
					<li class= "dropdown primaire"> <a href="#" class="dropdown-toggle primaire"
							data-toggle="dropdown" role="button" aria-expanded="false"><span
								class="glyphicon glyphicon-pushpin">&ensp;</span> Elements<span
								class="caret"></span></a>
							<ul class="dropdown-menu">
								<li><a href="./Instrument.html">Instruments</a></li>
								<li><a href="./Environment.html">Environments</a></li>
								<li><a href="./Measurand.html">Measurands</a></li>
							</ul>
						</li>
					<li class="active primaire"><a href="./CreateExperiment.html" class="primaire"><span
								class="glyphicon glyphicon-plus">&ensp;</span>Add experiment</a></li>
				</ul>
				
				
			</div>
		</div>	
		 
		
		<div class="navbar-default sidebar" role="navigation">
                <div  id ="acordion" class="sidebar-nav navbar-collapse">
                    <ul class="nav" id="side-menu">
                     	 <div id="tree"></div>
                     </ul>                   
                </div>
                <!-- /.sidebar-collapse -->
            </div>
            <!-- /.navbar-static-side -->
	</header>
	 <div id="page-wrapper">
	
	 	<div col-md-10>
			<legend ng-model="loaded_file"> {{ loaded_file }} </legend>
			<canvas id="line" class="chart chart-line" chart-data="data"
				chart-labels="labels" chart-series="series"
				chart-options="options"
				chart-dataset-override="datasetOverride" chart-click="onClick">
			</canvas>
		</div>		
	</div>
	<footer class="footer"> </footer>
</body>
</html>
