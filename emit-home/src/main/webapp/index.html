<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<title>EMIT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet"
	href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	


<link href="css/sb-admin-2.css" rel="stylesheet">
<link href="css/bootstrap-treeview.css" rel="stylesheet">


   
</head>

<script type="text/javascript" src="DJS/Chart.min.js"></script>
<script type="text/javascript"
	src="https://code.jquery.com/jquery-3.1.1.min.js"></script>
<script type="text/javascript"
	src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript"
	src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.2/angular.min.js"></script>
<script type="text/javascript" src="DJS/angular-chart.min.js"></script>

<script type="text/javascript" src="DJS/sb-admin-2.js"></script>
<script type="text/javascript" src="DJS/bootstrap-treeview.js"></script>
<script type="text/javascript">
	
	
	var app = angular.module('app', [ 'chart.js' ]);	
	// tableau de navigation des items
	var downloadComplete = false;
	var tableDownload = [];	
	var tree = [];
	
	
	
	app.controller('myCtrl', function($scope, $http,$q) {	
		
		
		$scope.retrive_observer_name = function(uri){
			var name ="";
			angular.forEach($scope.observerlist, function(value) {//$scope.measurandlist
				if(uri == value.uri){
					name = value.name;
				}
			});
			return name;
		}
		
		
		var initSelectableTree = function() {
	          return $('#tree').treeview({
	            data: tree,
	            multiSelect: false,
	            onNodeSelected: function(event, node) {
	             console.log(node.text +' was selected')
	             $scope.afficher_test(node.text);
	            },
	            onNodeUnselected: function (event, node) {
	             
	            }
	          });
	        };
	        
		
			
			
			
			function fillMeasurement(datalow,measurementset){
				/*while(tableDownload[4] == false	){
					// attente télechargement
				}*/
				var node =[];
				var i = 0;
				angular.forEach($scope.measurementlist, function(value){
					if(measurementset == value.measurementSet){
						var data = {
								text:value.data,
								color:"black"
							}
						node[i] = data;
						i++
					}				
				});
				if(node[0]!=null){
				datalow.nodes = node;
				}
			}
			
			function fillMeasurementSet(datalow,experiment){
				
				var node =[];
				var i = 0;
				angular.forEach($scope.measurementsetlist, function(value){
					
					if(experiment == value.experiment){
						var observer = $scope.retrive_observer_name(value.observer);
						var data = {
							text:observer,
							color:"black",
							selectable:false
						}
						fillMeasurement(data,value.id);
						node[i] = data;
						i++;
					}
				});
				if(node[0]!=null){
				datalow.nodes = node;
				}
			}
			
			function fillExperiment(process,indice){
				
				var node =[];
				var i = 0;
				angular.forEach($scope.experimentlist, function(value){
					
					if(process == value.measurand){
						var dstarted = new Date(value.started);
						var data ={
								text:dstarted,
								color:"black",
								selectable:false
						}
						fillMeasurementSet(data,value.id);
						console.log(data);
						node[i] = data;
						i++;
					}
					
					
				});
				tree[indice].nodes = node;
			};
			
			function fillMeasurand(){
				var i = 0;
				angular.forEach($scope.measurandlist, function(value){
					var data = {
						text:value.name,
						color:"black",
						selectable:false,
						state: { expanded: false }
					};				
					tree[i] =data;
					fillExperiment(value.process,i);
					i++;
				});
				console.log(tree[0].text);
				var $selectableTree = initSelectableTree();
				
			};
			
			
	

		$scope.refresh = function() {
			// déclaration des promesses (voir promises)
			var experiment = $http.get("http://172.21.1.18/emit/experiment/list");
			var observer = $http.get("http://172.21.1.18/emit/observer/list");
			var observee = $http.get("http://172.21.1.18/emit/observee/list");
			var measure = $http.get("http://172.21.1.18/emit/measure/list");
			var measurement = $http.get("http://172.21.1.18/emit/measurement/list");
			var measurand = $http.get("http://172.21.1.18/emit/measurand/list");
			var measurementset = $http.get("http://172.21.1.18/emit/measurementSet/list");
			
			// attente de la réalisation de toutes les promesses
			$q.all([experiment,observer,observee,measure,measurement,measurand,measurementset]).then(function(values){
				//console.log(angular.toJson(values[0].data))
				$scope.experimentlist = values[0].data;
				$scope.observerlist = values[1].data;
				$scope.observeelist= values[2].data;
				$scope.measurelist=values[3].data;
				$scope.measurementlist = values[4].data;
				$scope.measurandlist =  values[5].data;
				$scope.measurementsetlist = values[6].data;
				//réalisation des opérations souaitées
				fillMeasurand();
			});
			
			/*
			$http.get("http://172.21.1.18/emit/experiment/list").then(
					function(response) {
						$scope.experimentlist = response.data;
						
					});
			$http.get("http://172.21.1.18/emit/observer/list").then(
					function(response) {
						$scope.observerlist = response.data;
						
					});
			$http.get("http://172.21.1.18/emit/observee/list").then(
					function(response) {
						$scope.observeelist = response.data;
						
					});
			$http.get("http://172.21.1.18/emit/measure/list").then(
					function(response) {
						$scope.measurelist = response.data;
						
					});
			$http.get("http://172.21.1.18/emit/measurement/list").then(
					function(response) {
						$scope.measurementlist = response.data;
						
					});
			$http.get("http://172.21.1.18/emit/measurand/list").then(
					function(response) {
						$scope.measurandlist = response.data;					
						setTimeout(fillMeasurand, 500);
					});
			$http.get("http://172.21.1.18/emit/measurementSet/list").then(
					function(response) {
						$scope.measurementsetlist = response.data;
						
					});
		
			console.log(tableDownload);
			*/
		}

		$scope.refresh();

		$scope.afficher_test = function(file_name) {
			var retour_test = [];
			var serie = [];
			var serie1 = [];
			var globalSerie = [];

			$http.get(
					"http://172.21.1.18/emit/test/test?file_name=" + file_name)
					.then(function(response) {
						retour_test = response.data;
						//console.log(retour_test.length);

						for (var i = 0; i < retour_test.length; i++) {
							
							serie[i] = retour_test[i].x / 1000;
							serie1[i] = retour_test[i];						
							
							console.log(i);
							// renvois
						}

						$scope.loaded_file = "Loaded file : " + file_name;
						console.log(angular.toJson(serie1));
						globalSerie.push(serie1);

						$scope.labels = serie
						$scope.series = [ 'Series A' ];

						console.log(serie);

						$scope.data = globalSerie;
						$scope.onClick = function(points, evt) {
							console.log(points, evt);

						}
					});
		}

		$scope.modify = function(primarykey, info) {
			sessionStorage.setItem("primarykey", primarykey);
			sessionStorage.setItem("info", info);
		}
		$scope.deleteobject = function(element, adresse_delete, primarykey) {
			var can_delete = true;
			switch (element) {
			case 'observer':
				angular.forEach($scope.measurementsetlist, function(value) {
					if (value.observer == primarykey) {
						can_delete = false;
					}
				});
				break;
			case 'observee':
				angular.forEach($scope.experimentlist, function(value) {
					if (value.observee == primarykey) {
						can_delete = false;
					}
				});
				break;
			case 'measurement':
				angular.forEach($scope.experimentlist, function(value) {
					if (value.measurand == primarykey) {
						can_delete = false;
					}
				});
				break;
			default:
				alert("Not possible yet");
				can_delete = false;
			}

			if (can_delete == true) {
				var data = {
					uri : primarykey
				}
				var url_delete = "http://172.21.1.18/emit" + adresse_delete;
				$http.post(url_delete, data).then(function(response) {

				});
				alert("This " + element + " is deleted");
				$scope.refresh();
			} else {
				alert("This " + element + " can't be deleted");
			}

		}
	});
</script>
<body ng-app="app" ng-controller="myCtrl">
	<header>
		<div class="navbar navbar-default navbar-custom navbar-static-top">
			<div class="container">
				 <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                    <span class="sr-only">Toggle navigation</span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                    <span class="icon-bar"></span>
                </button>
				<a class="navbar-brand" href="./index.html">EMIT</a>
				<a href="./index.html">EMIT</a>
				
			</div>
		</div>	
		 
		
		<div class="navbar-default sidebar" role="navigation">
                <div  id ="acordion" class="sidebar-nav navbar-collapse">
                    <ul class="nav" id="side-menu">
                     	 <div id="tree"></div>
                     </ul>                   
                </div>
                <!-- /.sidebar-collapse -->
            </div>
            <!-- /.navbar-static-side -->
	</header>
	 <div id="page-wrapper">
	
	 	<div col-md-10>
			<legend ng-model="loaded_file"> {{ loaded_file }} </legend>
			<canvas id="line" class="chart chart-line" chart-data="data"
				chart-labels="labels" chart-series="series"
				chart-options="options"
				chart-dataset-override="datasetOverride" chart-click="onClick">
			</canvas>
		</div>		
	</div>
	<footer class="footer"> </footer>
</body>
</html>
